# AVA Release Workflow
# =====================
# Creates GitHub releases when version tags are pushed
# Builds Windows installer with Tauri and standalone server executable

name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  # ============================================================================
  # Build Python Package (pip installable)
  # ============================================================================
  build-python:
    name: Build Python Package
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Build package
        run: python -m build

      - name: Check package
        run: twine check dist/*

      - name: Upload Python artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-dist
          path: dist/

  # ============================================================================
  # Build Standalone Server Executable (PyInstaller)
  # ============================================================================
  build-server:
    name: Build Server Executable
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build server executable
        run: python scripts/build_server.py --clean

      - name: Verify executable
        run: |
          if (Test-Path "dist/ava-server.exe") {
            Write-Host "Server executable built successfully"
            $size = (Get-Item "dist/ava-server.exe").Length / 1MB
            Write-Host "Size: $([math]::Round($size, 2)) MB"
          } else {
            Write-Host "ERROR: Executable not found"
            exit 1
          }
        shell: pwsh

      - name: Upload server executable
        uses: actions/upload-artifact@v4
        with:
          name: server-windows
          path: dist/ava-server.exe

  # ============================================================================
  # Build Tauri Desktop App (Windows)
  # ============================================================================
  build-tauri:
    name: Build Tauri App (Windows)
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: ui/package-lock.json

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: ui/src-tauri

      - name: Install frontend dependencies
        working-directory: ui
        run: npm ci || npm install

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SKIP_ENV_VALIDATION: true
          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
        with:
          projectPath: ui

      - name: Extract version from tag
        id: version
        run: |
          $version = "${{ github.ref_name }}" -replace '^v', ''
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        shell: pwsh

      - name: Generate update manifest
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          $date = Get-Date -Format "yyyy-MM-ddTHH:mm:ssZ"

          # Find the installer files
          $nsisPath = Get-ChildItem -Path "ui/src-tauri/target/release/bundle/nsis/*.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
          $sigPath = Get-ChildItem -Path "ui/src-tauri/target/release/bundle/nsis/*.sig" -ErrorAction SilentlyContinue | Select-Object -First 1

          if ($nsisPath) {
            $fileName = $nsisPath.Name
            $url = "https://github.com/NAME0x0/AVA/releases/download/v$version/$fileName"

            # Read signature if available
            $signature = ""
            if ($sigPath -and (Test-Path $sigPath.FullName)) {
              $signature = Get-Content $sigPath.FullName -Raw
              $signature = $signature.Trim()
            }

            # Create latest.json for Tauri updater
            $manifest = @{
              version = $version
              notes = "AVA v$version release"
              pub_date = $date
              platforms = @{
                "windows-x86_64" = @{
                  signature = $signature
                  url = $url
                }
              }
            }

            $manifest | ConvertTo-Json -Depth 4 | Out-File -FilePath "latest.json" -Encoding utf8
            Write-Host "Generated latest.json for version $version"
            Write-Host "Signature: $signature"
          }
        shell: pwsh

      - name: Upload Tauri artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tauri-windows
          path: |
            ui/src-tauri/target/release/bundle/msi/*.msi
            ui/src-tauri/target/release/bundle/nsis/*.exe
            latest.json

  # ============================================================================
  # Build Frontend (for browser/non-Tauri users)
  # ============================================================================
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ui

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: ui/package-lock.json

      - name: Install dependencies
        run: npm ci || npm install

      - name: Build
        run: npm run build
        env:
          SKIP_ENV_VALIDATION: true

      - name: Create frontend archive
        run: |
          cd ..
          # Create archive with .next and public (if exists)
          if [ -d "ui/public" ]; then
            tar -czvf frontend-build.tar.gz ui/.next ui/public
          else
            tar -czvf frontend-build.tar.gz ui/.next
          fi

      - name: Upload Frontend artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend-build.tar.gz

  # ============================================================================
  # Create GitHub Release
  # ============================================================================
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-python, build-server, build-frontend, build-tauri]

    steps:
      - uses: actions/checkout@v4

      - name: Download Python artifacts
        uses: actions/download-artifact@v4
        with:
          name: python-dist
          path: dist/

      - name: Download Server artifacts
        uses: actions/download-artifact@v4
        with:
          name: server-windows
          path: server/

      - name: Download Frontend artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: ./

      - name: Download Tauri artifacts
        uses: actions/download-artifact@v4
        with:
          name: tauri-windows
          path: tauri-build/

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Extract changelog for version
        id: changelog
        run: |
          # Extract changelog section for this version
          VERSION="${{ steps.version.outputs.VERSION }}"
          CHANGELOG=$(awk "/## \[${VERSION}\]/,/^## \[/" CHANGELOG.md | head -n -1)
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="Release v${VERSION}"
          fi
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: AVA v${{ steps.version.outputs.VERSION }}
          body: |
            # AVA v${{ steps.version.outputs.VERSION }}

            ${{ steps.changelog.outputs.CHANGELOG }}

            ## Quick Start

            AVA uses a two-app architecture: start the **Server** first, then launch the **UI**.

            ### Step 1: Start the Backend

            **Option A: Standalone Executable (Recommended)**
            1. Download `ava-server.exe`
            2. Run it - you'll see startup diagnostics in the console
            3. Keep this window open while using AVA

            **Option B: Python Package**
            ```bash
            pip install ava-agent
            ava-server --port 8085
            ```

            **Option C: From Source**
            ```bash
            python ava_server.py
            ```

            ### Step 2: Launch the UI

            **Desktop App**
            Download and run `AVA_${{ steps.version.outputs.VERSION }}_x64-setup.exe`

            **Browser**
            Open http://localhost:3000 after running `npm run dev` in the ui/ directory

            ## Requirements

            - **Ollama** must be running with `gemma3:4b` model
            - Python 3.10+ (only for pip install or source)

            ## Downloads

            | Component | Description |
            |-----------|-------------|
            | `ava-server.exe` | Standalone backend server |
            | `AVA_*_x64-setup.exe` | Desktop UI installer |
            | `ava_agent-*.whl` | Python wheel package |

          files: |
            dist/*.whl
            dist/*.tar.gz
            server/ava-server.exe
            frontend-build.tar.gz
            tauri-build/**/*.exe
            tauri-build/**/*.msi
            tauri-build/latest.json
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
